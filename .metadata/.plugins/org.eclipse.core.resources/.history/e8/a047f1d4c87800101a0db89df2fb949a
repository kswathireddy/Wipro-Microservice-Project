package com.wipro.swathi.demo.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.wipro.swathi.demo.CustomException;
import com.wipro.swathi.demo.dto.BookingDTO;
import com.wipro.swathi.demo.dto.DestionationDTO;

import com.wipro.swathi.demo.dto.PackageTourDTO;
import com.wipro.swathi.demo.dto.UserDTO;
import com.wipro.swathi.demo.entity.Booking;
import com.wipro.swathi.demo.enums.Status;

import com.wipro.swathi.demo.feign.PackageService;
import com.wipro.swathi.demo.feign.UserService;
import com.wipro.swathi.demo.repo.BookingRepo;

import feign.FeignException;

@Service
public class BookingServiceImpl implements BookingService {
    
    @Autowired
    private BookingRepo bookingRepository;
    
    @Autowired
    private PackageService packageService;
    
    @Autowired
    private UserService userService;
   

   

    @Override
    public Booking cancel(Long id) {
        Booking booking = bookingRepository.findById(id)
                .orElseThrow(() -> new CustomException("Booking not found: " + id));

        booking.setStatus(Status.CANCELLED);
        return bookingRepository.save(booking);
    }

    @Override
    public Booking addBooking(Booking bookingDTO) {
        

        return bookingRepository.save(bookingDTO);
    }

	@Override
	public BookingDTO getById(Long id) {
		// TODO Auto-generated method stub
		Booking booking = bookingRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Booking not found"));

        BookingDTO dto = new BookingDTO();
        dto.setId(booking.getId());
        dto.setStartDate(booking.getStartDate());
        dto.setStatus(booking.getStatus());

        // Get User info safely
        try {
            UserDTO user = userService.getById(booking.getUserId());
            dto.setUser(user);
        } catch (FeignException.NotFound e) {
            dto.setUser(null); // or default value
        }

        // Get Package info safely
        try {
            PackageTourDTO pack = packageService.getById(booking.getPackageId());
            dto.setPackageInfo(pack);
        } catch (FeignException.NotFound e) {
            dto.setPackageInfo(null); // or default value
        }

        return dto;
    }
	}
}
